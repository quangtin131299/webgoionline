<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Khoa Pham WebRTC</title>
        <script src="jquery.js"></script>
        <script src="peer.js"></script>
        <script src="socket.io.js"></script>
    </head>
    <body>
        <div id="div-chat">
            <p>Online user:</p>
            <ul id="ulUser">
            </ul>
            <h3 id="my-peer">Your Id: </h3>
            <video id="localStream" width="300" controls></video>
            <br /><br />
            <video id="remoteStream" width="300" controls></video>
            <br /><br />
            <input type="text" id="remoteId" placeholder="Remote ID">
            <button id="btnCall">Call</button>
        </div>
        <div id="div-dang-ky">
            <br /><br />
            <input type="text" id="txtUsername" placeholder="Enter your username">
            <button id="btnSignUp">Sign Up</button>
        </div>
    </body>
    <script>
	
			function openStream() {
				const config = { audio: false, video: true };
				return navigator.mediaDevices.getUserMedia(config);
			}

			function playStream(idVideoTag, stream) {
				const video = document.getElementById(idVideoTag);
				video.srcObject = stream;
				video.play();
			}

			// openStream()
			// .then(stream => playStream('localStream', stream));

			const peer = new Peer({ 
				key: 'peerjs', 
				host: 'mypeer3005.herokuapp.com', 
				secure: true, 
				port: 443, 
				config: customConfig 
			});

			peer.on('open', id => {
				$('#my-peer').append(id);
				$('#btnSignUp').click(() => {
					const username = $('#txtUsername').val();
					socket.emit('NGUOI_DUNG_DANG_KY', { ten: username, peerId: id });
				});
			});

			//Caller
			$('#btnCall').click(() => {
				const id = $('#remoteId').val();
				openStream()
				.then(stream => {
					playStream('localStream', stream);
					const call = peer.call(id, stream);
					call.on('stream', remoteStream => playStream('remoteStream', remoteStream));
				});
			});

			//Callee
			peer.on('call', call => {
				openStream()
				.then(stream => {
					call.answer(stream);
					playStream('localStream', stream);
					call.on('stream', remoteStream => playStream('remoteStream', remoteStream));
				});
			});

			$('#ulUser').on('click', 'li', function() {
				const id = $(this).attr('id');
				console.log(id);
				openStream()
				.then(stream => {
					playStream('localStream', stream);
					const call = peer.call(id, stream);
					call.on('stream', remoteStream => playStream('remoteStream', remoteStream));
				});
			});

</script>
</html>
